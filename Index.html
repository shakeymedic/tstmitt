<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TST & MITT Triage Training Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .casualty-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .casualty-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .priority-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .p1 { background-color: #ef4444; color: white; } /* Red */
        .p2 { background-color: #f59e0b; color: white; } /* Amber */
        .p3 { background-color: #22c55e; color: white; } /* Green */
        .not-breathing { background-color: #3b82f6; color: white; } /* Blue for 'Not Breathing' as per JESIP */
        .deceased { background-color: #1f2937; color: white; } /* Grey/Black for deceased */
        
        .btn-triage {
            transition: all 0.2s;
        }

        .btn-triage:hover:not(:disabled) {
            transform: scale(1.05);
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .image-modal-content {
             max-width: 90vw;
             max-height: 90vh;
             width: auto;
             height: auto;
             padding: 1rem;
        }
        .feedback-correct {
            color: #166534; /* Green-800 */
        }
        .feedback-incorrect {
            color: #991B1B; /* Red-800 */
        }
        .casualty-svg-container {
            width: 80px;
            height: 120px;
            margin-right: 1rem;
        }

        @keyframes flash-red {
            0%, 100% { background-color: white; }
            50% { background-color: #fecaca; } /* Red-200 */
        }

        .deteriorated-flash {
            animation: flash-red 1.5s ease-in-out;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .triage-button, 
            button[data-answer],
            button[data-triage-choice] {
                min-height: 3.5rem;
                font-size: 1rem;
                touch-action: manipulation;
            }
            
            .casualty-card {
                touch-action: pan-y;
            }
            
            .modal-content {
                width: 95%;
                max-height: 85vh;
            }
        }

        /* Speed round timer bar */
        .timer-bar {
            height: 4px;
            background: linear-gradient(to right, #22c55e 0%, #f59e0b 50%, #ef4444 100%);
            transition: width 1s linear;
        }

        /* Swipe indicator */
        .swipe-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            z-index: 40;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8 flex flex-col sm:flex-row items-center justify-center gap-4">
            <img src="https://iili.io/KGQOvkl.md.png" alt="WMEBEM Logo" class="h-20 w-20">
            <div>
                <h1 class="text-4xl font-bold text-gray-900">TST & MITT Triage Trainer</h1>
                <p class="text-lg text-gray-600 mt-2">A Major Incident Triage Training Tool</p>
            </div>
        </header>

        <div id="setupScreen" class="bg-white p-8 rounded-lg shadow-lg max-w-2xl mx-auto">
            <h2 class="text-2xl font-semibold mb-6 text-center">Create New Simulation</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Training Mode</label>
                    <div id="modeSelector" class="flex border border-gray-300 rounded-lg overflow-hidden">
                        <button data-mode="teach" class="mode-button flex-1 p-3 font-semibold text-white bg-blue-600 transition-colors duration-200">Teach</button>
                        <button data-mode="test" class="mode-button flex-1 p-3 font-semibold text-gray-600 bg-gray-200 transition-colors duration-200">Test</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Environment</label>
                    <div id="environmentSelector" class="flex border border-gray-300 rounded-lg overflow-hidden">
                        <button data-environment="prehospital" class="environment-button flex-1 p-3 font-semibold text-white bg-blue-600 transition-colors duration-200">Pre-Hospital</button>
                        <button data-environment="inhospital" class="environment-button flex-1 p-3 font-semibold text-gray-600 bg-gray-200 transition-colors duration-200">In-Hospital</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Triage System</label>
                    <div id="systemSelector" class="flex border border-gray-300 rounded-lg overflow-hidden">
                        <button data-system="tst_mitt" class="system-button flex-1 p-2 text-sm font-semibold text-white bg-blue-600 transition-colors duration-200">TST & MITT</button>
                        <button data-system="tst" class="system-button flex-1 p-2 text-sm font-semibold text-gray-600 bg-gray-200 transition-colors duration-200">TST Only</button>
                        <button data-system="mitt" class="system-button flex-1 p-2 text-sm font-semibold text-gray-600 bg-gray-200 transition-colors duration-200">MITT Only</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Training Focus</label>
                    <select id="trainingFocus" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="standard">Standard</option>
                        <option value="paediatric">Paediatric Focus (70% children)</option>
                        <option value="burns">Burns Focus (Fire/Explosion)</option>
                        <option value="cbrn">CBRN Focus (Chemical Incidents)</option>
                        <option value="speed">Speed Round (30s per casualty)</option>
                    </select>
                </div>
            </div>

            <div>
                <div class="mb-6">
                    <label for="incidentType" class="block text-sm font-medium text-gray-700 mb-2">Type of Incident</label>
                    <select id="incidentType" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options will be populated based on environment selection -->
                    </select>
                </div>
                
                <div id="vehicleCountContainer" class="mb-6">
                    <label for="vehicleCount" class="block text-sm font-medium text-gray-700 mb-2">Number of Vehicles/Carriages</label>
                    <input id="vehicleCount" type="number" value="3" min="1" max="10" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="mb-8">
                    <label for="casualtyCountInput" class="block text-sm font-medium text-gray-700 mb-2">Number of Casualties</label>
                    <input id="casualtyCountInput" type="number" value="15" min="1" max="50" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <button id="startSimButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300">
                Start Simulation
            </button>
        </div>

        <div id="simulationScreen" class="hidden">
            <div class="flex justify-between items-start flex-col md:flex-row gap-4 mb-6">
                <div>
                    <h2 id="simTitle" class="text-3xl font-bold text-gray-900"></h2>
                    <p id="simSubtitle" class="text-lg text-gray-600"></p>
                </div>
                <div class="flex gap-2">
                    <button id="viewAlgosButton" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">View Algorithms</button>
                    <button id="endSimButton" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">End Simulation</button>
                </div>
            </div>

            <div id="timerDisplay" class="hidden bg-blue-100 border-l-4 border-blue-600 p-4 mb-4 rounded-lg">
                <p class="font-semibold text-blue-800">Time Elapsed: <span id="timer" class="font-mono text-2xl">00:00</span></p>
            </div>

            <div id="phaseDisplay" class="hidden bg-amber-100 border-l-4 border-amber-600 p-4 mb-4 rounded-lg">
                <p id="phaseText" class="font-semibold text-amber-800"></p>
                <button id="startMittButton" class="hidden mt-2 bg-amber-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-700">Start MITT Phase</button>
            </div>

            <div id="speedRoundTimer" class="hidden bg-red-100 border-l-4 border-red-600 p-4 mb-4 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <p class="font-semibold text-red-800">Casualty Time Remaining: <span id="casualtyTimer" class="font-mono text-2xl">30</span>s</p>
                    <button id="skipCasualtyButton" class="bg-red-600 text-white font-semibold py-1 px-3 rounded hover:bg-red-700">Skip</button>
                </div>
                <div class="w-full bg-gray-300 rounded-full h-2 overflow-hidden">
                    <div id="speedTimerBar" class="timer-bar h-full" style="width: 100%"></div>
                </div>
            </div>

            <div class="mb-4 flex justify-between items-center">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="showClinicalImages" class="mr-2 h-4 w-4">
                    <span class="text-sm font-medium text-gray-700">Show Clinical Findings</span>
                </label>
            </div>

            <div id="methaneReport" class="bg-red-100 border-l-4 border-red-600 p-4 mb-6 rounded-lg text-sm">
            </div>

            <div class="mb-4">
                 <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 text-white text-xs font-semibold">
                    <div class="p-3 rounded-lg p1 flex-grow text-center">P1: <span id="p1Count">0</span></div>
                    <div class="p-3 rounded-lg p2 flex-grow text-center">P2: <span id="p2Count">0</span></div>
                    <div class="p-3 rounded-lg p3 flex-grow text-center">P3: <span id="p3Count">0</span></div>
                    <div class="p-3 rounded-lg deceased flex-grow text-center">Deceased: <span id="deceasedCount">0</span></div>
                    <div class="p-3 rounded-lg bg-gray-500 flex-grow text-center">Untriaged: <span id="untriagedCount">0</span></div>
                 </div>
            </div>

            <div id="casualtiesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>
        </div>

        <div id="triageModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">Triage Casualty <span id="modalCasualtyId"></span></h3>
                    <button id="closeModalButton" class="text-2xl font-bold">&times;</button>
                </div>
                
                <div id="modal-top-section" class="mb-4">
                     <div id="modal-svg-container" class="w-48 mx-auto mb-4 flex-shrink-0">
                        </div>
                     <div class="bg-gray-100 p-3 rounded-lg mb-4">
                         <p class="text-sm italic">" <span id="modalInjuryDescription"></span> "</p>
                     </div>
                     <div id="modalPatientDetails" class="grid grid-cols-2 gap-x-4 gap-y-2 p-3 bg-gray-200 rounded-lg text-sm">
                         </div>
                </div>


                <div id="tstSection">
                    <h4 id="tstSectionTitle" class="text-lg font-semibold mb-4 border-b pb-2"></h4>
                    
                    <div id="tst-walking" class="hidden mb-4">
                        <p class="font-semibold text-lg">Is the casualty able to walk?</p>
                        <div class="flex gap-4 mt-2">
                            <button data-answer="walk-yes" class="flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">Yes</button>
                            <button data-answer="walk-no" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">No</button>
                        </div>
                    </div>
                    <div id="tst-bleeding" class="hidden mb-4">
                        <p class="font-semibold text-lg">Is there severe, life-threatening bleeding?</p>
                        <div class="flex gap-4 mt-2">
                             <button data-answer="bleeding-yes" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">Yes</button>
                             <button data-answer="bleeding-no" class="flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">No</button>
                        </div>
                    </div>
                    <div id="tst-talking" class="hidden mb-4">
                        <p class="font-semibold text-lg">Is the casualty talking?</p>
                        <div class="flex gap-4 mt-2">
                             <button data-answer="talking-yes" class="flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">Yes</button>
                             <button data-answer="talking-no" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">No</button>
                        </div>
                    </div>
                     <div id="tst-penetrating" class="hidden mb-4">
                        <p class="font-semibold text-lg">Is there a penetrating injury to the torso?</p>
                        <div class="flex gap-4 mt-2">
                             <button data-answer="penetrating-yes" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">Yes</button>
                             <button data-answer="penetrating-no" class="flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">No</button>
                        </div>
                    </div>

                    <div id="mitt-catastrophic-bleeding" class="hidden mb-4">
                        <p class="font-semibold text-lg">Is there catastrophic bleeding?</p>
                        <div class="flex gap-4 mt-2">
                             <button data-answer="cat-bleed-yes" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">Yes</button>
                             <button data-answer="cat-bleed-no" class="flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">No</button>
                        </div>
                    </div>
                    <div id="tst-breathing" class="hidden mb-4">
                        <p class="font-semibold text-lg">Are they breathing?</p>
                        <div class="flex gap-4 mt-2">
                             <button data-answer="breathe-yes" class="flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">Yes</button>
                             <button data-answer="breathe-no" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">No</button>
                        </div>
                    </div>
                    <div id="mitt-responds-voice" class="hidden mb-4">
                        <p class="font-semibold text-lg">Do they respond to voice?</p>
                        <div class="flex gap-4 mt-2">
                             <button data-answer="voice-yes" class="flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">Yes</button>
                             <button data-answer="voice-no" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">No</button>
                        </div>
                    </div>
                    <div id="mitt-age" class="hidden mb-4">
                        <p class="font-semibold text-lg">Is the casualty aged over 2 years?</p>
                        <div class="flex gap-4 mt-2">
                             <button data-answer="age-yes" class="flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">Yes</button>
                             <button data-answer="age-no" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">No</button>
                        </div>
                    </div>
                    <div id="mitt-resp-rate" class="hidden mb-4">
                        <p class="font-semibold text-lg">Is the respiratory rate between 12 and 23?</p>
                        <div class="flex gap-4 mt-2">
                             <button data-answer="rr-yes" class="flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">Yes</button>
                             <button data-answer="rr-no" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">No</button>
                        </div>
                    </div>
                    <div id="mitt-hr" class="hidden mb-4">
                        <p class="font-semibold text-lg">Is the heart rate between 60 and 119?</p>
                        <div class="flex gap-4 mt-2">
                             <button data-answer="hr-yes" class="flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600">Yes</button>
                             <button data-answer="hr-no" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600">No</button>
                        </div>
                    </div>

                    <div id="priorityResult" class="hidden">
                        <div class="mb-4 p-4 rounded-lg" id="resultCard"></div>
                        <div id="teachExplanation" class="bg-gray-100 p-4 rounded-lg text-sm mb-4 hidden">
                            <h5 class="font-semibold mb-2">Explanation:</h5>
                            <div id="explanationContent"></div>
                        </div>
                        <button id="confirmTriageButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Confirm Triage</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="imageModal" class="modal-overlay hidden">
            <div class="bg-white rounded-lg image-modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Triage Algorithms</h3>
                    <button id="closeImageModalButton" class="text-2xl font-bold">&times;</button>
                </div>
                <div class="flex flex-col gap-4">
                    <img src="images/TST.png" alt="TST Algorithm" class="w-full rounded-lg">
                    <img src="images/MITT.png" alt="MITT Algorithm" class="w-full rounded-lg">
                </div>
            </div>
        </div>

        <div id="reportModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">Simulation Complete</h3>
                </div>
                <div id="reportContent">
                </div>
                <div class="flex gap-2 mt-4">
                    <button id="downloadPdfButton" class="flex-1 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">ðŸ“„ Download PDF Certificate</button>
                    <button id="closeReportButton" class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Close & Return to Menu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM References ---
        const setupScreen = document.getElementById('setupScreen');
        const simulationScreen = document.getElementById('simulationScreen');
        const startSimButton = document.getElementById('startSimButton');
        const endSimButton = document.getElementById('endSimButton');
        const viewAlgosButton = document.getElementById('viewAlgosButton');
        const startMittButton = document.getElementById('startMittButton');
        const incidentTypeSelect = document.getElementById('incidentType');
        const vehicleCountInput = document.getElementById('vehicleCount');
        const vehicleCountContainer = document.getElementById('vehicleCountContainer');
        const casualtyCountInput = document.getElementById('casualtyCountInput');
        const casualtiesContainer = document.getElementById('casualtiesContainer');
        const triageModal = document.getElementById('triageModal');
        const imageModal = document.getElementById('imageModal');
        const closeImageModalButton = document.getElementById('closeImageModalButton');
        const reportModal = document.getElementById('reportModal');
        const closeReportButton = document.getElementById('closeReportButton');
        const simTitle = document.getElementById('simTitle');
        const simSubtitle = document.getElementById('simSubtitle');
        const phaseText = document.getElementById('phaseText');
        const phaseDisplay = document.getElementById('phaseDisplay');
        const timerDisplay = document.getElementById('timerDisplay');
        const timer = document.getElementById('timer');
        const methaneReport = document.getElementById('methaneReport');
        const modeSelector = document.getElementById('modeSelector');
        const environmentSelector = document.getElementById('environmentSelector');
        const systemSelector = document.getElementById('systemSelector');
        const trainingFocusSelect = document.getElementById('trainingFocus');
        const speedRoundTimer = document.getElementById('speedRoundTimer');
        const casualtyTimer = document.getElementById('casualtyTimer');
        const speedTimerBar = document.getElementById('speedTimerBar');
        const skipCasualtyButton = document.getElementById('skipCasualtyButton');
        const showClinicalImagesCheckbox = document.getElementById('showClinicalImages');
        const downloadPdfButton = document.getElementById('downloadPdfButton');
        
        // --- State Variables ---
        let casualties = [];
        let currentCasualty = null;
        let currentMode = 'teach'; // 'teach' or 'test'
        let currentEnvironment = 'prehospital';
        let triageSystem = 'tst_mitt'; // 'tst_mitt', 'tst', or 'mitt'
        let currentPhase = 'tst'; // 'tst' or 'mitt'
        let timerInterval = null;
        let secondsElapsed = 0;
        let trainingFocus = 'standard'; // 'standard', 'paediatric', 'burns', 'cbrn', 'speed'
        let showClinicalImages = false;
        let speedRoundInterval = null;
        let casualtyTimeRemaining = 30;
        let currentCasualtyIndex = 0;
        let simulationStartTime = null;

        // Incident types by environment
        const incidentTypes = {
            prehospital: [
                { value: 'RTC', label: 'Road Traffic Collision (RTC)' },
                { value: 'Train', label: 'Train Crash' },
                { value: 'HGV', label: 'HGV Incident' },
                { value: 'Blast', label: 'Blast Incident' },
                { value: 'BuildingCollapse', label: 'Building Collapse' },
                { value: 'IndustrialExplosion', label: 'Industrial Explosion' },
                { value: 'CrowdCrush', label: 'Stadium/Crowd Crush' },
                { value: 'Chemical', label: 'Chemical Incident (CBRN)' },
                { value: 'Fire', label: 'Major Fire' },
                { value: 'MTFA', label: 'Marauding Terrorist Firearms Attack (MTFA)' }
            ],
            inhospital: [
                { value: 'RTCArrival', label: 'Multiple RTC Casualties Arriving' },
                { value: 'BlastArrival', label: 'Blast Casualties Arriving' },
                { value: 'BuildingCollapseArrival', label: 'Building Collapse Casualties Arriving' },
                { value: 'FireArrival', label: 'Major Fire Casualties Arriving' },
                { value: 'MTFAArrival', label: 'MTFA Casualties Arriving' },
                { value: 'ChemicalArrival', label: 'Chemical Incident Casualties Arriving' },
                { value: 'IndustrialExplosionArrival', label: 'Industrial Explosion Casualties Arriving' },
                { value: 'CrowdCrushArrival', label: 'Crowd Crush Casualties Arriving' }
            ]
        };
        
        // Update incident types dropdown based on environment
        const updateIncidentTypes = (environment) => {
            const incidents = incidentTypes[environment];
            incidentTypeSelect.innerHTML = incidents.map(inc => 
                `<option value="${inc.value}">${inc.label}</option>`
            ).join('');
            // Trigger the vehicle count visibility check
            incidentTypeSelect.dispatchEvent(new Event('change'));
        };
        
        // Initialise with pre-hospital incidents
        updateIncidentTypes('prehospital');
        
        // --- Utility Functions ---
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const probability = (percent) => Math.random() < (percent / 100);
        const pickRandom = (arr) => arr[getRandomInt(0, arr.length - 1)];

        // Incidents that should show vehicle count (only pre-hospital)
        const vehicleIncidents = ['RTC', 'Train'];
        
        // Update vehicle count visibility when incident type changes
        incidentTypeSelect.addEventListener('change', () => {
            const incidentType = incidentTypeSelect.value;
            const isInHospital = incidentType.includes('Arrival');
            
            // Only show vehicle count for specific pre-hospital incidents
            if (!isInHospital && vehicleIncidents.includes(incidentType)) {
                vehicleCountContainer.classList.remove('hidden');
                const label = vehicleCountContainer.querySelector('label');
                label.textContent = incidentType === 'Train' ? 'Number of Carriages' : 'Number of Vehicles';
            } else {
                vehicleCountContainer.classList.add('hidden');
            }
        });

        // --- Casualty Generation ---
        const generateCasualty = (id, incidentType) => {
            const consciousLevels = ['Alert', 'Voice', 'Pain', 'Unresponsive'];
            const canWalk = probability(30);
            const sex = pickRandom(['Male', 'Female']);
            let age, resps, pulse, conscious;
            
            // Adjust paediatric probability based on training focus
            let paediatricProbability = 15;
            if (trainingFocus === 'paediatric') paediatricProbability = 70;
            
            // Paediatric Vitals
            const randomAge = probability(paediatricProbability) ? getRandomInt(0, 12) : getRandomInt(13, 80);
            age = randomAge;
            if (age <= 1) { // Infant
                resps = getRandomInt(30, 60); pulse = getRandomInt(100, 160);
            } else if (age <= 3) { // Toddler
                resps = getRandomInt(24, 40); pulse = getRandomInt(90, 150);
            } else if (age <= 5) { // Preschool
                resps = getRandomInt(22, 34); pulse = getRandomInt(80, 140);
            } else if (age <= 12) { // School-age
                resps = getRandomInt(18, 30); pulse = getRandomInt(70, 120);
            } else { // Adult
                resps = getRandomInt(10, 28); pulse = getRandomInt(50, 130);
            }
            conscious = 'Alert';

            // Environment-specific roles and context
            const isInHospital = incidentType.includes('Arrival');
            
            let role, preExistingCondition = null;
            
            if (isInHospital) {
                // Hospital - only patients arriving from incidents
                const baseIncidentType = incidentType.replace('Arrival', '');
                // Use roles from the base incident type to avoid spoilers
                const roleMap = {
                    'RTC': ['Driver', 'Front Passenger', 'Rear Passenger', 'Cyclist', 'Pedestrian', 'Motorcyclist'],
                    'Blast': ['Civilian', 'Shopper', 'Office Worker', 'Restaurant Diner'],
                    'BuildingCollapse': ['Resident', 'Construction Worker', 'Visitor', 'Passer-by'],
                    'Fire': ['Resident', 'Office Worker', 'Shop Customer', 'Shop Staff'],
                    'MTFA': ['Shopper', 'Shop Worker', 'Tourist', 'Restaurant Diner'],
                    'Chemical': ['Plant Worker', 'Lab Technician', 'Nearby Resident'],
                    'IndustrialExplosion': ['Factory Worker', 'Shift Supervisor', 'Contractor'],
                    'CrowdCrush': ['Spectator', 'Event Attendee', 'Vendor']
                };
                const roles = roleMap[baseIncidentType] || ['Patient'];
                role = pickRandom(roles);
                
                // Some patients have pre-existing conditions affecting baseline obs
                if (probability(30)) {
                    const conditions = [
                        { name: 'COPD', respEffect: () => { resps = Math.max(resps, getRandomInt(20, 28)); } },
                        { name: 'Asthma', respEffect: () => { resps = Math.max(resps, getRandomInt(22, 30)); } },
                        { name: 'IHD', respEffect: () => { pulse = getRandomInt(70, 100); } },
                        { name: 'Diabetes', respEffect: () => {} },
                        { name: 'Hypertension', respEffect: () => { pulse = getRandomInt(65, 95); } },
                        { name: 'Previous MI', respEffect: () => { pulse = getRandomInt(60, 90); } }
                    ];
                    const condition = pickRandom(conditions);
                    preExistingCondition = condition.name;
                    if (age > 50) {
                        condition.respEffect();
                    }
                }
            } else {
                // Pre-hospital roles
                const roles = { 
                    RTC: ['Driver', 'Front Passenger', 'Rear Passenger', 'Cyclist', 'Pedestrian', 'Motorcyclist', 'Back Seat Child', 'Van Driver'], 
                    Train: ['Passenger', 'Commuter', 'Train Guard', 'Platform Bystander', 'Station Staff', 'Ticket Inspector'], 
                    HGV: ['HGV Driver', 'Co-driver', 'Warehouse Staff', 'Forklift Operator', 'Loading Bay Worker', 'Bystander'], 
                    Blast: ['Civilian', 'Shopper', 'Office Worker', 'Restaurant Diner', 'First Responder', 'Security Guard', 'Delivery Driver'],
                    BuildingCollapse: ['Resident', 'Construction Worker', 'Site Visitor', 'Passer-by', 'Architect', 'Building Inspector', 'Neighbour'],
                    IndustrialExplosion: ['Factory Worker', 'Shift Supervisor', 'Maintenance Staff', 'QA Inspector', 'Security Guard', 'Contractor', 'Delivery Driver'],
                    CrowdCrush: ['Spectator', 'Event Steward', 'Vendor', 'Security Staff', 'Ticket Holder', 'VIP Guest', 'Performer'],
                    Chemical: ['Plant Worker', 'First Responder', 'Lab Technician', 'Nearby Resident', 'Contractor', 'Inspector'], 
                    Fire: ['Resident', 'Office Worker', 'Shop Customer', 'Shop Staff', 'Cleaner', 'Security Guard', 'Maintenance Staff'], 
                    MTFA: ['Shopper', 'Shop Worker', 'Tourist', 'Police Officer', 'Security Guard', 'Restaurant Diner', 'Bank Customer']
                };
                role = pickRandom(roles[incidentType] || ['Civilian']);
            }

            let injuries = [], injuryDescription = '';

            // Incident-specific injury patterns
            const potentialInjuries = getInjuriesForIncident(incidentType, isInHospital);
            
            if (canWalk) {
                injuryDescription = getMinorInjuryDescription(incidentType, isInHospital, role, preExistingCondition);
            } else {
                const severity = Math.random();
                if (severity < 0.1) { // Critical - not breathing
                    resps = 0; pulse = getRandomInt(0, 40); conscious = 'Unresponsive'; 
                    injuries.push(pickRandom(potentialInjuries.filter(i => i.type === 'head' || i.type === 'critical')));
                } else if (severity < 0.4) { // Severe
                    conscious = consciousLevels[getRandomInt(1,3)]; 
                    injuries.push(pickRandom(potentialInjuries.filter(i => i.type === 'penetrating' || i.type === 'severe')));
                    if(probability(50)) injuries.push(pickRandom(potentialInjuries.filter(i => i.type === 'bleeding')));
                } else if (severity < 0.8) { // Moderate
                    conscious = 'Alert';
                    injuries.push(pickRandom(potentialInjuries.filter(i => i.type === 'fracture' || i.type === 'moderate')));
                    if(probability(30)) injuries.push(pickRandom(potentialInjuries.filter(i => i.type === 'bleeding')));
                } else { // Entrapment/spinal
                    conscious = 'Alert';
                    injuryDescription = getEntrapmentDescription(incidentType, isInHospital, role);
                }
                if(injuries.length > 0) {
                    injuryDescription = injuries.map(i => i.desc).join(' ');
                }
            }

            const hasSevereBleeding = injuries.some(i => i.type === 'bleeding');
            const hasCatastrophicBleeding = hasSevereBleeding && probability(60);
            const hasPenetratingInjury = injuries.some(i => i.type === 'penetrating' || i.type === 'severe');
            
            let isTalking = resps > 0 && (conscious === 'Alert' || conscious === 'Voice');
            if (conscious === 'Unresponsive' || conscious === 'Pain') isTalking = false;

            return { 
                id, age, sex, role, canWalk, 
                isBreathing: resps > 0, resps, pulse, conscious, 
                airwayClears: probability(50), injuries, 
                triageStatus: 'untriaged', 
                userTstTriage: null, userMittTriage: null, 
                correctTst: null, correctMitt: null, 
                injuryDescription, hasSevereBleeding, isTalking, 
                hasPenetratingInjury, hasCatastrophicBleeding,
                preExistingCondition
            };
        };

        // Get incident-appropriate injuries
        const getInjuriesForIncident = (incidentType, isInHospital) => {
            const baseInjuries = [
                { type: 'head', location: 'head', desc: 'Significant head trauma with visible bleeding.' },
                { type: 'head', location: 'head', desc: 'Severe head injury with CSF otorrhoea.' },
                { type: 'head', location: 'head', desc: 'Depressed skull fracture palpable.' },
                { type: 'head', location: 'head', desc: 'Battle\'s sign and raccoon eyes evident.' },
                { type: 'bleeding', location: 'leg', desc: 'Deep laceration to thigh with pulsatile bleeding.' },
                { type: 'bleeding', location: 'leg', desc: 'Femoral artery injury with massive haemorrhage.' },
                { type: 'bleeding', location: 'arm', desc: 'Arterial bleeding from brachial artery injury.' },
                { type: 'bleeding', location: 'arm', desc: 'Traumatic partial amputation with severe bleeding.' },
                { type: 'bleeding', location: 'abdomen', desc: 'Abdominal wound with visible bleeding.' },
                { type: 'fracture', location: 'leg', desc: 'Obvious compound femoral fracture.' },
                { type: 'fracture', location: 'leg', desc: 'Open tibial fracture with bone protrusion.' },
                { type: 'fracture', location: 'arm', desc: 'Grossly deformed and swollen forearm.' },
                { type: 'fracture', location: 'arm', desc: 'Open humeral fracture with neurovascular compromise.' },
                { type: 'fracture', location: 'chest', desc: 'Multiple rib fractures with flail segment.' },
            ];

            // In-hospital incident injury patterns (patients arriving from incidents)
            if (isInHospital) {
                const arrivalIncidents = {
                    RTCArrival: [
                        { type: 'severe', location: 'chest', desc: 'Flail chest with paradoxical movement.' },
                        { type: 'severe', location: 'chest', desc: 'Tension pneumothorax with tracheal deviation.' },
                        { type: 'fracture', location: 'leg', desc: 'Bilateral femoral fractures causing severe pain.' },
                        { type: 'head', location: 'head', desc: 'Severe TBI with declining GCS.' },
                        { type: 'critical', location: 'chest', desc: 'Cardiac tamponade from blunt chest trauma.' },
                        { type: 'penetrating', location: 'chest', desc: 'Impaled object in chest wall.' },
                        { type: 'fracture', location: 'chest', desc: 'Unstable pelvis with retroperitoneal bleeding.' },
                        { type: 'bleeding', location: 'leg', desc: 'Degloving injury to lower leg.' },
                        { type: 'severe', location: 'abdomen', desc: 'Rigid abdomen suggesting haemoperitoneum.' },
                        { type: 'burns', location: 'torso', desc: 'Friction burns from road surface.' }
                    ],
                    BlastArrival: [
                        { type: 'severe', location: 'chest', desc: 'Primary blast lung with haemoptysis.' },
                        { type: 'severe', location: 'chest', desc: 'Pneumothorax from barotrauma.' },
                        { type: 'penetrating', location: 'torso', desc: 'Multiple penetrating shrapnel wounds.' },
                        { type: 'penetrating', location: 'abdomen', desc: 'Blast fragmentation injuries to abdomen.' },
                        { type: 'severe', location: 'abdomen', desc: 'Suspected hollow viscus perforation.' },
                        { type: 'burns', location: 'torso', desc: 'Extensive flash burns to face and torso.' },
                        { type: 'burns', location: 'torso', desc: 'Third-degree burns to exposed areas.' },
                        { type: 'fracture', location: 'leg', desc: 'Traumatic amputation with tourniquetable bleeding.' },
                        { type: 'fracture', location: 'leg', desc: 'Mangled extremity from blast injury.' },
                        { type: 'critical', location: 'head', desc: 'TBI with bilateral tympanic membrane rupture.' },
                        { type: 'bleeding', location: 'leg', desc: 'Catastrophic arterial bleeding from blast injury.' },
                        { type: 'severe', location: 'chest', desc: 'Blast-induced cardiac contusion.' }
                    ],
                    BuildingCollapseArrival: [
                        { type: 'severe', location: 'chest', desc: 'Crush injury to chest with respiratory distress.' },
                        { type: 'severe', location: 'chest', desc: 'Traumatic asphyxia with petechial rash.' },
                        { type: 'fracture', location: 'leg', desc: 'Bilateral lower limb fractures from entrapment.' },
                        { type: 'severe', location: 'abdomen', desc: 'Abdominal crush injury with rigid abdomen.' },
                        { type: 'severe', location: 'abdomen', desc: 'Suspected solid organ injury from crushing.' },
                        { type: 'critical', location: 'head', desc: 'Head injury with decreasing GCS from falling debris.' },
                        { type: 'fracture', location: 'chest', desc: 'Pelvic crush injury with instability.' },
                        { type: 'bleeding', location: 'arm', desc: 'Upper limb vascular injury from compression.' },
                        { type: 'severe', location: 'leg', desc: 'Compartment syndrome developing in crushed limb.' },
                        { type: 'critical', location: 'chest', desc: 'Crush syndrome with rhabdomyolysis.' }
                    ],
                    FireArrival: [
                        { type: 'burns', location: 'torso', desc: 'Extensive full-thickness burns to chest and arms.' },
                        { type: 'burns', location: 'torso', desc: 'Circumferential burns requiring escharotomy.' },
                        { type: 'critical', location: 'chest', desc: 'Severe smoke inhalation with stridor.' },
                        { type: 'critical', location: 'chest', desc: 'Carbon monoxide poisoning with altered consciousness.' },
                        { type: 'severe', location: 'chest', desc: 'Airway burns with singed facial hair.' },
                        { type: 'severe', location: 'chest', desc: 'Inhalational injury with soot in airways.' },
                        { type: 'fracture', location: 'leg', desc: 'Jump injury with bilateral calcaneal fractures.' },
                        { type: 'fracture', location: 'leg', desc: 'Lumbar spine compression fracture from fall.' },
                        { type: 'burns', location: 'head', desc: 'Facial burns with periorbital oedema.' },
                        { type: 'severe', location: 'chest', desc: 'Cyanide toxicity from synthetic material combustion.' }
                    ],
                    MTFAArrival: [
                        { type: 'penetrating', location: 'chest', desc: 'Gunshot wound to chest with sucking wound.' },
                        { type: 'penetrating', location: 'chest', desc: 'Through-and-through chest wound with haemothorax.' },
                        { type: 'penetrating', location: 'abdomen', desc: 'Gunshot wound to abdomen with evisceration.' },
                        { type: 'penetrating', location: 'abdomen', desc: 'Stab wound to abdomen with protruding omentum.' },
                        { type: 'bleeding', location: 'leg', desc: 'Catastrophic arterial bleeding from leg gunshot.' },
                        { type: 'bleeding', location: 'arm', desc: 'Defensive knife wound with arterial bleeding.' },
                        { type: 'severe', location: 'chest', desc: 'Multiple penetrating torso injuries from gunfire.' },
                        { type: 'critical', location: 'head', desc: 'Penetrating head injury with visible brain matter.' },
                        { type: 'fracture', location: 'leg', desc: 'Femoral shaft fracture from high-velocity GSW.' },
                        { type: 'penetrating', location: 'torso', desc: 'Multiple stab wounds to trunk.' },
                        { type: 'bleeding', location: 'chest', desc: 'Exsanguinating chest wound.' }
                    ],
                    ChemicalArrival: [
                        { type: 'critical', location: 'chest', desc: 'Respiratory distress with bronchospasm.' },
                        { type: 'critical', location: 'chest', desc: 'Pulmonary oedema from chemical inhalation.' },
                        { type: 'burns', location: 'torso', desc: 'Chemical burns to exposed skin areas.' },
                        { type: 'burns', location: 'torso', desc: 'Caustic burns requiring extensive irrigation.' },
                        { type: 'severe', location: 'chest', desc: 'Severe respiratory irritation with stridor.' },
                        { type: 'severe', location: 'head', desc: 'Chemical conjunctivitis with corneal damage.' },
                        { type: 'moderate', location: 'head', desc: 'Severe eye pain with lacrimation and blepharospasm.' },
                        { type: 'critical', location: 'chest', desc: 'Nerve agent exposure with fasciculations.' },
                        { type: 'severe', location: 'chest', desc: 'Cholinergic crisis from organophosphate.' }
                    ],
                    IndustrialExplosionArrival: [
                        { type: 'burns', location: 'torso', desc: 'Full-thickness burns to chest, face and arms.' },
                        { type: 'burns', location: 'torso', desc: 'Electrical burns with entry and exit wounds.' },
                        { type: 'severe', location: 'chest', desc: 'Blast lung injury with respiratory distress.' },
                        { type: 'penetrating', location: 'abdomen', desc: 'Penetrating abdominal injury from flying machinery.' },
                        { type: 'penetrating', location: 'chest', desc: 'Multiple metallic foreign bodies in chest.' },
                        { type: 'critical', location: 'head', desc: 'Inhalational injury with airway burns.' },
                        { type: 'fracture', location: 'leg', desc: 'Crush injury to lower limbs from machinery.' },
                        { type: 'bleeding', location: 'arm', desc: 'Traumatic amputation at industrial site.' },
                        { type: 'severe', location: 'chest', desc: 'Chemical and thermal burns combined.' }
                    ],
                    CrowdCrushArrival: [
                        { type: 'severe', location: 'chest', desc: 'Traumatic asphyxia with facial petechiae.' },
                        { type: 'critical', location: 'chest', desc: 'Unable to expand chest, severe respiratory distress.' },
                        { type: 'severe', location: 'chest', desc: 'Compression asphyxia with hypoxia.' },
                        { type: 'fracture', location: 'chest', desc: 'Multiple rib fractures with respiratory compromise.' },
                        { type: 'fracture', location: 'chest', desc: 'Sternal fracture from crowd pressure.' },
                        { type: 'head', location: 'head', desc: 'Head trampling injury with scalp lacerations.' },
                        { type: 'severe', location: 'chest', desc: 'Suspected cardiac contusion from compression.' },
                        { type: 'fracture', location: 'leg', desc: 'Lower limb crush injuries from trampling.' }
                    ]
                };
                
                return [...baseInjuries, ...(arrivalIncidents[incidentType] || [])];
            }

            // Pre-hospital incident patterns
            const incidentSpecific = {
                RTC: [
                    { type: 'severe', location: 'chest', desc: 'Flail chest with paradoxical breathing.' },
                    { type: 'severe', location: 'chest', desc: 'Sternal fracture with cardiac contusion.' },
                    { type: 'fracture', location: 'leg', desc: 'Bilateral femoral fractures causing shock.' },
                    { type: 'fracture', location: 'leg', desc: 'Dashboard knee injury with posterior hip dislocation.' },
                    { type: 'head', location: 'head', desc: 'Severe head injury with bleeding from ears and nose.' },
                    { type: 'critical', location: 'head', desc: 'Basilar skull fracture with CSF leak.' },
                    { type: 'severe', location: 'abdomen', desc: 'Seatbelt sign with hollow viscus injury.' },
                    { type: 'penetrating', location: 'chest', desc: 'Steering wheel impalement to chest.' },
                    { type: 'bleeding', location: 'leg', desc: 'Open femoral fracture with arterial bleeding.' },
                    { type: 'fracture', location: 'chest', desc: 'Unstable pelvic fracture from side impact.' }
                ],
                Train: [
                    { type: 'severe', location: 'torso', desc: 'Massive crush injury to chest and abdomen.' },
                    { type: 'severe', location: 'chest', desc: 'Bilateral haemothoraces from deceleration.' },
                    { type: 'fracture', location: 'leg', desc: 'Traumatic amputation below knee with tourniqueted limb.' },
                    { type: 'severe', location: 'abdomen', desc: 'Penetrating abdominal injury with evisceration.' },
                    { type: 'critical', location: 'head', desc: 'Severe TBI from being thrown in carriage.' },
                    { type: 'fracture', location: 'leg', desc: 'Bilateral lower limb fractures from entrapment.' },
                    { type: 'bleeding', location: 'arm', desc: 'Degloving injury to upper limb.' },
                    { type: 'severe', location: 'chest', desc: 'Ruptured diaphragm with herniated organs.' }
                ],
                HGV: [
                    { type: 'severe', location: 'chest', desc: 'Crushed chest with paradoxical movement.' },
                    { type: 'critical', location: 'chest', desc: 'Traumatic aortic injury suspected.' },
                    { type: 'fracture', location: 'chest', desc: 'Open pelvic fracture with haemorrhage.' },
                    { type: 'severe', location: 'head', desc: 'Depressed skull fracture palpable.' },
                    { type: 'bleeding', location: 'leg', desc: 'Traumatic amputation with exsanguination.' },
                    { type: 'severe', location: 'abdomen', desc: 'Blunt abdominal trauma with rigid abdomen.' }
                ],
                Blast: [
                    { type: 'severe', location: 'chest', desc: 'Primary blast lung injury with haemoptysis.' },
                    { type: 'severe', location: 'chest', desc: 'Bilateral pneumothoraces from barotrauma.' },
                    { type: 'penetrating', location: 'torso', desc: 'Multiple penetrating injuries from shrapnel.' },
                    { type: 'penetrating', location: 'chest', desc: 'Embedded metallic fragments in chest wall.' },
                    { type: 'severe', location: 'abdomen', desc: 'Suspected hollow viscus perforation from blast.' },
                    { type: 'burns', location: 'torso', desc: 'Extensive flash burns to face, arms and anterior chest.' },
                    { type: 'burns', location: 'torso', desc: 'Thermal and blast injuries combined.' },
                    { type: 'fracture', location: 'leg', desc: 'Traumatic amputation with tourniquetable bleeding.' },
                    { type: 'bleeding', location: 'leg', desc: 'Mangled lower extremity with catastrophic bleeding.' },
                    { type: 'critical', location: 'head', desc: 'Blast TBI with tympanic membrane rupture and disorientation.' },
                    { type: 'severe', location: 'abdomen', desc: 'Blast evisceration with exposed bowel.' }
                ],
                BuildingCollapse: [
                    { type: 'severe', location: 'chest', desc: 'Crush injury with respiratory compromise.' },
                    { type: 'severe', location: 'chest', desc: 'Tension pneumothorax from crushing.' },
                    { type: 'fracture', location: 'leg', desc: 'Bilateral lower limb fractures from prolonged entrapment.' },
                    { type: 'severe', location: 'abdomen', desc: 'Abdominal crush injury with rigid, distended abdomen.' },
                    { type: 'critical', location: 'head', desc: 'Head injury with decreasing GCS from falling concrete.' },
                    { type: 'severe', location: 'leg', desc: 'Compartment syndrome in crushed limb.' },
                    { type: 'critical', location: 'chest', desc: 'Crush syndrome with dark urine.' },
                    { type: 'fracture', location: 'chest', desc: 'Pelvic crush with haemodynamic instability.' }
                ],
                IndustrialExplosion: [
                    { type: 'burns', location: 'torso', desc: 'Full-thickness burns to chest and face.' },
                    { type: 'burns', location: 'torso', desc: 'Circumferential burns to torso requiring escharotomy.' },
                    { type: 'severe', location: 'chest', desc: 'Blast lung with respiratory distress.' },
                    { type: 'penetrating', location: 'abdomen', desc: 'Penetrating abdominal injury from flying debris.' },
                    { type: 'critical', location: 'head', desc: 'Inhalational injury with airway burns and stridor.' },
                    { type: 'bleeding', location: 'arm', desc: 'Partial traumatic amputation of upper limb.' },
                    { type: 'severe', location: 'chest', desc: 'Chemical and thermal injury combined.' }
                ],
                CrowdCrush: [
                    { type: 'severe', location: 'chest', desc: 'Traumatic asphyxia with facial and neck petechiae.' },
                    { type: 'critical', location: 'chest', desc: 'Unable to expand chest, severe cyanosis.' },
                    { type: 'severe', location: 'chest', desc: 'Compression asphyxia with hypoxia.' },
                    { type: 'fracture', location: 'chest', desc: 'Multiple rib fractures with haemopneumothorax.' },
                    { type: 'head', location: 'head', desc: 'Head trampling injury with depressed fracture.' },
                    { type: 'severe', location: 'chest', desc: 'Cardiac contusion from crowd pressure.' }
                ],
                Chemical: [
                    { type: 'critical', location: 'chest', desc: 'Respiratory distress with severe bronchospasm.' },
                    { type: 'critical', location: 'chest', desc: 'Pulmonary oedema from toxic inhalation.' },
                    { type: 'burns', location: 'torso', desc: 'Chemical burns to all exposed skin.' },
                    { type: 'burns', location: 'torso', desc: 'Caustic injuries requiring decontamination.' },
                    { type: 'severe', location: 'chest', desc: 'Inhalational injury with stridor and wheeze.' },
                    { type: 'severe', location: 'head', desc: 'Chemical conjunctivitis with corneal injury.' }
                ],
                Fire: [
                    { type: 'burns', location: 'torso', desc: 'Extensive partial and full-thickness burns to chest and arms.' },
                    { type: 'burns', location: 'torso', desc: 'Circumferential burns requiring urgent escharotomy.' },
                    { type: 'critical', location: 'chest', desc: 'Smoke inhalation with respiratory distress and stridor.' },
                    { type: 'critical', location: 'chest', desc: 'Carbon monoxide poisoning with reduced consciousness.' },
                    { type: 'severe', location: 'chest', desc: 'Airway burns with singed nasal hairs and soot.' },
                    { type: 'fracture', location: 'leg', desc: 'Jump injury with bilateral calcaneal fractures.' },
                    { type: 'fracture', location: 'leg', desc: 'Vertebral compression fractures from fall.' },
                    { type: 'burns', location: 'head', desc: 'Facial burns with periorbital oedema obscuring vision.' }
                ],
                MTFA: [
                    { type: 'penetrating', location: 'chest', desc: 'Gunshot wound to chest with sucking wound.' },
                    { type: 'penetrating', location: 'chest', desc: 'Through-and-through GSW with haemothorax.' },
                    { type: 'penetrating', location: 'abdomen', desc: 'Gunshot wound to abdomen with visible evisceration.' },
                    { type: 'penetrating', location: 'abdomen', desc: 'Multiple stab wounds to abdomen.' },
                    { type: 'bleeding', location: 'leg', desc: 'Catastrophic arterial bleeding from femoral GSW.' },
                    { type: 'bleeding', location: 'arm', desc: 'Defensive slash wound with brachial artery injury.' },
                    { type: 'severe', location: 'chest', desc: 'Multiple penetrating torso injuries from automatic fire.' },
                    { type: 'critical', location: 'head', desc: 'Penetrating head injury with neurological deficit.' }
                ]
            };

            return [...baseInjuries, ...(incidentSpecific[incidentType] || [])];
        };

        const getMinorInjuryDescription = (incidentType, isInHospital, role, preExistingCondition) => {
            if (isInHospital) {
                const arrivalDescriptions = {
                    RTCArrival: [
                        "Minor whiplash with neck pain but independently mobile.",
                        "Superficial lacerations from broken windscreen glass, walking.",
                        "Complaining of chest pain from seatbelt but ambulant.",
                        "Bruising from airbag deployment, mobile and alert.",
                        "Minor soft tissue injuries, self-extricated from vehicle.",
                        preExistingCondition ? `Known ${preExistingCondition}, minor collision injuries, mobile.` : "Shaken with minor abrasions, walking into ED.",
                        "Wrist sprain from bracing on dashboard, ambulant.",
                        "Minor head laceration, refusing stretcher."
                    ],
                    BlastArrival: [
                        "Hearing loss and tinnitus from blast, independently mobile.",
                        "Minor lacerations from flying glass, walking wounded.",
                        "Blast exposure with tympanic membrane perforation, ambulant.",
                        "Superficial flash burns to face and hands, mobile.",
                        "Psychological distress but no significant physical injuries.",
                        "Bruising from being thrown by blast wave, walking.",
                        "Dust and debris in eyes, vision improving, mobile."
                    ],
                    BuildingCollapseArrival: [
                        "Escaped before major collapse, minor debris injuries, mobile.",
                        "Dust inhalation and coughing, independently ambulant.",
                        "Minor crush injury to foot but weight-bearing.",
                        "Superficial cuts from broken glass, walking.",
                        "Anxious about collapse but physically well, mobile.",
                        preExistingCondition ? `Known ${preExistingCondition}, evacuated safely, mobile.` : "Shaken with minor bruising, walking."
                    ],
                    FireArrival: [
                        "Minor smoke inhalation, coughing but ambulant.",
                        "Superficial burns to hand, independently mobile.",
                        "Smoke exposure with sore throat, walking.",
                        "Singed hair and eyebrows, no respiratory distress, mobile.",
                        "Minor burns to forearm, walking into ED.",
                        "Carbon monoxide exposure, improving with oxygen, ambulant."
                    ],
                    MTFAArrival: [
                        "Witnessed shooting, severe psychological distress but physically unharmed.",
                        "Minor defensive injury to hand, independently mobile.",
                        "Minor soft tissue injury from fall whilst taking cover, walking.",
                        "Laceration from broken glass whilst fleeing, ambulant.",
                        "Hiding during incident, shaken but no physical injuries.",
                        "Minor bruising from being pushed in crowd, mobile."
                    ],
                    ChemicalArrival: [
                        "Eye irrigation completed, vision improving, independently mobile.",
                        "Skin exposure with erythema, decontaminated, ambulant.",
                        "Mild respiratory irritation, improving with oxygen, walking.",
                        "Chemical splash to arm, washed off, mobile.",
                        preExistingCondition ? `Pre-existing ${preExistingCondition}, minor chemical exposure, stable and mobile.` : "Minimal exposure, ambulant for observation.",
                        "Coughing from fumes but improving, walking."
                    ],
                    IndustrialExplosionArrival: [
                        "Superficial burns to hands from heat, independently mobile.",
                        "Flash burns to face, walking into ED.",
                        "Coughing from smoke and fumes but ambulant.",
                        "Minor lacerations from flying debris, mobile.",
                        "Dust inhalation, improving, walking.",
                        "Bruising from being knocked over, ambulant."
                    ],
                    CrowdCrushArrival: [
                        "Bruising and minor soft tissue injuries, independently mobile.",
                        "Breathless but recovering and ambulant.",
                        "Minor trampling injuries to legs but walking.",
                        "Rib contusions from crowd pressure, mobile.",
                        "Superficial lacerations, walking into ED.",
                        "Shaken by crowd pressure but physically stable, ambulant."
                    ]
                };
                
                const options = arrivalDescriptions[incidentType] || [
                    "Minor injuries from incident, walking wounded.",
                    preExistingCondition ? `Known ${preExistingCondition}, minor injuries from incident, mobile.` : "Independently mobile with minor injuries."
                ];
                return pickRandom(options.filter(Boolean));
            }

            // Pre-hospital descriptions
            const descriptions = {
                RTC: [
                    "Minor whiplash with neck pain but independently mobile.",
                    "Superficial lacerations from broken glass, walking from scene.",
                    "Complaining of chest pain from seatbelt but fully ambulant.",
                    "Airbag facial abrasions, mobile and alert.",
                    "Minor bruising, self-extricated and walking."
                ],
                Train: [
                    "Shaken with minor bruising from being thrown, independently mobile.",
                    "Scalp laceration but alert and ambulant.",
                    "Twisted ankle from fall but able to weight bear.",
                    "Minor soft tissue injuries, walking from carriage.",
                    "Superficial cuts, mobile and alert."
                ],
                Blast: [
                    "Hearing loss and disorientation but independently ambulant.",
                    "Minor flash burns to face and hands, walking.",
                    "Blast-related tinnitus but otherwise well and mobile.",
                    "Superficial shrapnel wounds, walking from scene.",
                    "Bruising from being thrown, ambulant."
                ],
                BuildingCollapse: [
                    "Dust inhalation with coughing but independently mobile.",
                    "Minor cuts from debris but walking.",
                    "Frightened but no significant injuries, ambulant.",
                    "Bruising from falling rubble, mobile.",
                    "Superficial lacerations, walking from scene."
                ],
                IndustrialExplosion: [
                    "Superficial burns to hands but independently mobile.",
                    "Flash burns to face, walking away from scene.",
                    "Coughing from smoke but ambulant.",
                    "Minor lacerations, mobile and alert.",
                    "Bruising from being knocked over, walking."
                ],
                CrowdCrush: [
                    "Bruising and minor soft tissue injuries, independently mobile.",
                    "Breathless but recovering and ambulant.",
                    "Minor trampling injuries but walking.",
                    "Rib contusions but mobile.",
                    "Superficial wounds, walking from scene."
                ],
                Chemical: [
                    "Mild respiratory irritation but independently ambulant.",
                    "Eye irritation with lacrimation, walking.",
                    "Skin exposure with erythema, mobile.",
                    "Coughing from fumes but ambulant.",
                    "Minor chemical splash, walking for decontamination."
                ],
                Fire: [
                    "Minor smoke inhalation, independently ambulant.",
                    "Superficial burns to hands, walking.",
                    "Coughing but walking away from scene.",
                    "Singed hair and minor burns, mobile.",
                    "Smoke exposure, ambulant and alert."
                ],
                MTFA: [
                    "Minor laceration from debris, independently mobile.",
                    "Psychological distress but no physical injuries, walking.",
                    "Minor soft tissue injury but ambulant.",
                    "Superficial cut, mobile and alert.",
                    "Bruising from fall whilst fleeing, walking."
                ],
                HGV: [
                    "Minor bruising but fully mobile.",
                    "Superficial cuts from debris, walking.",
                    "Shaken but no significant injuries, ambulant.",
                    "Minor soft tissue injuries, mobile."
                ]
            };
            const defaults = [
                "Appears shaken with minor lacerations, independently mobile.",
                "Complaining of pain but fully ambulant.",
                "Walking wounded with minor injuries."
            ];
            const options = descriptions[incidentType] || defaults;
            return pickRandom(options);
        };

        const getEntrapmentDescription = (incidentType, isInHospital, role) => {
            if (isInHospital) {
                const arrivalDescriptions = {
                    RTCArrival: "Extricated from vehicle, alert but unable to move lower limbs, suspected spinal injury.",
                    BlastArrival: "Was trapped under rubble at scene, now alert and talking but cannot move legs.",
                    BuildingCollapseArrival: "Prolonged entrapment at scene, freed but complaining of severe back pain and leg weakness.",
                    FireArrival: "Rescued from building, suspected spinal injury, alert but immobile.",
                    MTFAArrival: "Was taking cover and afraid to move, suspected penetrating spinal injury.",
                    ChemicalArrival: "Collapsed at scene and unable to move, alert but weak.",
                    IndustrialExplosionArrival: "Trapped by machinery at scene, conscious but immobile.",
                    CrowdCrushArrival: "Was on the ground being crushed, now freed but cannot feel lower limbs."
                };
                return arrivalDescriptions[incidentType] || "Arrived from scene, unable to move, suspected spinal injury.";
            }

            // Pre-hospital descriptions
            const descriptions = {
                RTC: "Trapped in vehicle wreckage, alert but unable to move lower limbs, suspected spinal cord injury.",
                Train: "Pinned by carriage debris, complaining of severe back pain and leg weakness.",
                Blast: "Trapped under rubble, alert and talking but cannot move lower body.",
                BuildingCollapse: "Buried under debris from waist down, alert and responsive but immobile.",
                IndustrialExplosion: "Trapped by fallen machinery, conscious but unable to move.",
                CrowdCrush: "Was on the ground being crushed, now freed but cannot feel legs, suspected cord injury.",
                HGV: "Pinned between vehicles, alert but severe pain on any movement attempt.",
                Fire: "Rescued from collapsed floor, suspected spinal injury from fall.",
                Chemical: "Collapsed and unable to move, alert but profoundly weak.",
                MTFA: "Taking cover, unable to move due to suspected spinal injury from fall."
            };
            return descriptions[incidentType] || "Complaining of severe back pain and cannot feel legs, suspected spinal cord injury.";
        };
        
        const calculateCorrectTst = (c) => {
            if (c.canWalk) return 'p3';
            if (c.hasSevereBleeding) return 'p1';
            if (c.isTalking) {
                return c.hasPenetratingInjury ? 'p1' : 'p2';
            }
            if (c.isBreathing || (!c.isBreathing && c.airwayClears)) {
                return 'p1';
            }
            return 'deceased';
        };

        const calculateCorrectMitt = (c) => {
            if (c.hasCatastrophicBleeding) return 'p1';
            if (c.canWalk) return 'p3';
            if (!c.isBreathing) {
                 return c.airwayClears ? 'p1' : 'deceased'; 
            }
            const respondsToVoice = c.conscious === 'Alert' || c.conscious === 'Voice';
            if (!respondsToVoice) return 'p1';
            if (c.age <= 2) return 'p1';
            if (c.resps < 12 || c.resps > 23) return 'p1';
            if (c.pulse < 60 || c.pulse > 119) return 'p2';
            return 'p2';
        };

        // --- UI Rendering ---
        const generateCasualtySvg = (casualty, options = { large: false, includeKey: false }) => {
            let markers = '';
            const locations = {
                head: { x: 50, y: 20 },
                chest: { x: 50, y: 55 },
                abdomen: { x: 50, y: 75 },
                arm: { x: 25, y: 65 },
                leg: { x: 35, y: 115 },
                torso: { x: 50, y: 65 },
            };

            const scale = options.large ? 2 : 1;
            const strokeWidth = options.large ? 1.5 : 2;
            const locationOffsets = {};

            casualty.injuries.forEach(injury => {
                const pos = locations[injury.location] || locations.abdomen;
                const count = locationOffsets[injury.location] || 0;
                
                // Apply a horizontal "jitter" offset to avoid markers overlapping
                const offsetX = (count > 0) ? ((count % 2 === 1 ? 1 : -1) * Math.ceil(count / 2) * 8 * scale) : 0;
                const finalX = pos.x + offsetX;

                switch(injury.type) {
                    case 'penetrating':
                    case 'severe':
                    case 'head': 
                    case 'critical':
                    case 'burns':
                        markers += `<circle cx="${finalX}" cy="${pos.y}" r="${5 * scale}" fill="#ef4444" stroke="black" stroke-width="${strokeWidth / 2}"/>`;
                        break;
                    case 'bleeding':
                        markers += `<path d="M ${finalX - (5 * scale)} ${pos.y} Q ${finalX} ${pos.y + (15 * scale)}, ${finalX + (5 * scale)} ${pos.y} Z" fill="#ef4444"/>`;
                        break;
                    case 'fracture':
                    case 'moderate':
                         markers += `<text x="${finalX - (5 * scale)}" y="${pos.y + (5 * scale)}" font-weight="bold" font-size="${16 * scale}px">#</text>`;
                        break;
                }
                locationOffsets[injury.location] = count + 1;
            });
            
            let key = '';
            if (options.includeKey) {
                key = `
                    <g transform="translate(5, 160)" font-size="9px" font-family="Inter, sans-serif">
                        <circle cx="5" cy="5" r="5" fill="#ef4444"></circle>
                        <text x="15" y="9">
                            <tspan>Penetrating/</tspan>
                            <tspan x="15" dy="10">Severe/Burn</tspan>
                        </text>
                        <path d="M 5 35 Q 10 50, 15 35 Z" fill="#ef4444"></path>
                        <text x="25" y="43">Bleeding</text>
                        <text x="5" y="60" font-weight="bold">#</text>
                        <text x="15" y="60">Fracture</text>
                    </g>
                `;
            }

            const viewBox = options.large ? "0 0 100 220" : "0 0 100 150";

            return `
                <svg viewBox="${viewBox}" xmlns="http://www.w3.org/2000/svg">
                    <g stroke="black" stroke-width="${strokeWidth}" fill="none">
                        <circle cx="50" cy="20" r="15"/>
                        <line x1="50" y1="35" x2="50" y2="90"/>
                        <line x1="50" y1="50" x2="20" y2="70"/>
                        <line x1="50" y1="50" x2="80" y2="70"/>
                        <line x1="50" y1="90" x2="30" y2="140"/>
                        <line x1="50" y1="90" x2="70" y2="140"/>
                    </g>
                    ${markers}
                    ${key}
                </svg>
            `;
        };

        const renderCasualties = (deterioratedId = null) => {
            casualtiesContainer.innerHTML = '';
            casualties.forEach(c => {
                const card = document.createElement('div');
                card.id = `casualty-card-${c.id}`;
                card.className = `casualty-card bg-white p-4 rounded-lg shadow-md border-l-4 ${getBorderColor(c.triageStatus)}`;
                if (c.id === deterioratedId) {
                    card.classList.add('deteriorated-flash');
                }
                
                let buttonText = 'Triage Now';
                if (triageSystem === 'tst_mitt') { 
                    buttonText = currentPhase === 'tst' ? 'Triage (TST)' : 'Re-Triage (MITT)'; 
                } else if (triageSystem === 'mitt') {
                    buttonText = 'Triage (MITT)';
                } else {
                    buttonText = 'Triage (TST)';
                }

                let isButtonDisabled = (currentPhase === 'tst' && c.userTstTriage) || (currentPhase === 'mitt' && c.userMittTriage);

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex flex-grow">
                            <div class="casualty-svg-container flex-shrink-0">
                                ${generateCasualtySvg(c)}
                            </div>
                            <div class="flex-grow">
                                <p class="text-xs text-gray-500 mb-1">Casualty #${c.id} | ${c.age}yr ${c.sex} ${c.role}</p>
                                ${c.triageStatus !== 'untriaged' ? `<span class="priority-tag ${c.triageStatus} inline-block mb-2">${c.triageStatus.toUpperCase()}</span>` : ''}
                                <p class="text-sm text-gray-700 italic mb-2">"${c.injuryDescription}"</p>
                            </div>
                        </div>
                    </div>
                    <button class="triage-button w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 mt-3 ${isButtonDisabled ? 'opacity-50 cursor-not-allowed' : ''}" data-id="${c.id}" ${isButtonDisabled ? 'disabled' : ''}>${buttonText}</button>
                `;
                casualtiesContainer.appendChild(card);
            });
            updateCounts();
        };

        const getBorderColor = (status) => {
            switch(status) {
                case 'p1': return 'border-red-600';
                case 'p2': return 'border-amber-600';
                case 'p3': return 'border-green-600';
                case 'deceased': return 'border-gray-800';
                default: return 'border-gray-400';
            }
        };

        const updateCounts = () => {
            const counts = { p1: 0, p2: 0, p3: 0, deceased: 0, untriaged: 0 };
            casualties.forEach(c => {
                if (c.triageStatus === 'untriaged') counts.untriaged++;
                else counts[c.triageStatus]++;
            });
            document.getElementById('p1Count').textContent = counts.p1;
            document.getElementById('p2Count').textContent = counts.p2;
            document.getElementById('p3Count').textContent = counts.p3;
            document.getElementById('deceasedCount').textContent = counts.deceased;
            document.getElementById('untriagedCount').textContent = counts.untriaged;
        };

        // --- Simulation Control ---
        const startSimulation = () => {
            trainingFocus = trainingFocusSelect.value;
            let incidentType = incidentTypeSelect.value;
            const casualtyCount = parseInt(casualtyCountInput.value);
            
            // Override incident type for focused training
            if (trainingFocus === 'burns') {
                incidentType = currentEnvironment === 'prehospital' ? 'Fire' : 'FireArrival';
            } else if (trainingFocus === 'cbrn') {
                incidentType = currentEnvironment === 'prehospital' ? 'Chemical' : 'ChemicalArrival';
            }
            
            const incidentLabel = incidentTypes[currentEnvironment].find(i => i.value === incidentType).label;
            
            casualties = [];
            for (let i = 1; i <= casualtyCount; i++) {
                const c = generateCasualty(i, incidentType);
                c.correctTst = calculateCorrectTst(c);
                c.correctMitt = calculateCorrectMitt(c);
                casualties.push(c);
            }
            
            setupScreen.classList.add('hidden');
            simulationScreen.classList.remove('hidden');
            simTitle.textContent = incidentLabel;
            
            let subtitle = `Triage ${casualtyCount} casualties using ${triageSystem === 'tst_mitt' ? 'TST & MITT' : triageSystem.toUpperCase()}`;
            if (trainingFocus === 'paediatric') subtitle += ' - Paediatric Focus';
            else if (trainingFocus === 'burns') subtitle += ' - Burns Focus';
            else if (trainingFocus === 'cbrn') subtitle += ' - CBRN Focus';
            else if (trainingFocus === 'speed') subtitle += ' - Speed Round (30s per casualty)';
            simSubtitle.textContent = subtitle;
            
            // Show phase display and timer for specific systems
            if (triageSystem === 'tst_mitt' || triageSystem === 'mitt' || triageSystem === 'tst') {
                phaseDisplay.classList.remove('hidden');
                if (triageSystem === 'tst_mitt') {
                    currentPhase = 'tst';
                    phaseText.textContent = "Phase 1: Perform Triage Sieve (TST) on all casualties.";
                } else if (triageSystem === 'mitt') {
                    currentPhase = 'mitt';
                    phaseText.textContent = "Perform Triage Sort (MITT) on all casualties.";
                } else {
                    currentPhase = 'tst';
                    phaseText.textContent = "Perform Triage Sieve (TST) on all casualties.";
                }
            }

            // Show timer in test mode or speed round
            if (currentMode === 'test' || trainingFocus === 'speed') {
                timerDisplay.classList.remove('hidden');
                startTimer();
            }
            
            // Speed round setup
            if (trainingFocus === 'speed') {
                speedRoundTimer.classList.remove('hidden');
                currentCasualtyIndex = 0;
                simulationStartTime = Date.now();
                // Auto-open first casualty
                setTimeout(() => openTriageModal(casualties[0]), 500);
            }

            // Generate METHANE report
            const isInHospital = incidentType.includes('Arrival');
            generateMethaneReport(incidentType, casualtyCount, isInHospital);
            
            renderCasualties();
        };

        const generateMethaneReport = (incidentType, count, isInHospital) => {
            const incidentLabel = incidentTypes[currentEnvironment].find(i => i.value === incidentType).label;
            const vehicleCount = vehicleCountInput.value;
            
            let location = '';
            if (!isInHospital) {
                if (incidentType === 'RTC') location = `Multi-vehicle RTC involving ${vehicleCount} vehicles on major road`;
                else if (incidentType === 'Train') location = `Train derailment with ${vehicleCount} carriages affected`;
                else if (incidentType === 'Blast') location = 'Explosion in city centre commercial area';
                else if (incidentType === 'BuildingCollapse') location = 'Partial collapse of multi-storey building';
                else if (incidentType === 'IndustrialExplosion') location = 'Explosion at industrial facility';
                else if (incidentType === 'CrowdCrush') location = 'Crush at major sporting event';
                else if (incidentType === 'Chemical') location = 'Chemical release at industrial site';
                else if (incidentType === 'Fire') location = 'Major fire in commercial premises';
                else if (incidentType === 'MTFA') location = 'Active shooter incident in public space';
                else location = 'Major incident scene';
            } else {
                location = 'Emergency Department - Mass Casualty Arrival';
            }

            const hazards = !isInHospital ? 
                'Scene hazards include structural instability, secondary devices, and ongoing fire risk.' :
                'ED at capacity. Decontamination may be required.';
            
            methaneReport.innerHTML = `
                <h3 class="font-bold text-red-800 mb-2">METHANE Report</h3>
                <p class="mb-1"><strong>M</strong>ajor Incident Declared</p>
                <p class="mb-1"><strong>E</strong>xact Location: ${location}</p>
                <p class="mb-1"><strong>T</strong>ype: ${incidentLabel}</p>
                <p class="mb-1"><strong>H</strong>azards: ${hazards}</p>
                <p class="mb-1"><strong>A</strong>ccess: ${!isInHospital ? 'Emergency services establishing cordon' : 'Via ambulance entrance'}</p>
                <p class="mb-1"><strong>N</strong>umber of Casualties: Approximately ${count} casualties</p>
                <p class="mb-1"><strong>E</strong>mergency Services: ${!isInHospital ? 'Fire, Police, and Ambulance on scene' : 'ED activation, major incident protocol initiated'}</p>
            `;
        };

        const startTimer = () => {
            secondsElapsed = 0;
            timerInterval = setInterval(() => {
                secondsElapsed++;
                const mins = Math.floor(secondsElapsed / 60).toString().padStart(2, '0');
                const secs = (secondsElapsed % 60).toString().padStart(2, '0');
                timer.textContent = `${mins}:${secs}`;
            }, 1000);
        };

        const endSimulation = () => {
            if (timerInterval) clearInterval(timerInterval);
            if (speedRoundInterval) clearInterval(speedRoundInterval);
            generateReport();
            reportModal.classList.remove('hidden');
        };

        const generateReport = () => {
            const priorityValue = {
                'deceased': 0,
                'p3': 1,
                'p2': 2,
                'p1': 3
            };
            
            const stats = { tst: { correct: 0, underTriaged: 0, overTriaged: 0 }, mitt: { correct: 0, underTriaged: 0, overTriaged: 0 } };

            casualties.forEach(c => {
                if (triageSystem === 'tst' || triageSystem === 'tst_mitt') {
                    if (c.userTstTriage) {
                        const userValue = priorityValue[c.userTstTriage];
                        const correctValue = priorityValue[c.correctTst];
                        
                        if (userValue === correctValue) {
                            stats.tst.correct++;
                        } else if (userValue < correctValue) {
                            stats.tst.underTriaged++;
                        } else {
                            stats.tst.overTriaged++;
                        }
                    }
                }
                if (triageSystem === 'mitt' || triageSystem === 'tst_mitt') {
                    if (c.userMittTriage) {
                        const userValue = priorityValue[c.userMittTriage];
                        const correctValue = priorityValue[c.correctMitt];
                        
                        if (userValue === correctValue) {
                            stats.mitt.correct++;
                        } else if (userValue < correctValue) {
                            stats.mitt.underTriaged++;
                        } else {
                            stats.mitt.overTriaged++;
                        }
                    }
                }
            });

            const tstTriaged = stats.tst.correct + stats.tst.underTriaged + stats.tst.overTriaged;
            const mittTriaged = stats.mitt.correct + stats.mitt.underTriaged + stats.mitt.overTriaged;

            let html = `<div class="mb-6"><h4 class="text-xl font-bold mb-2">Simulation Summary</h4>`;
            
            if (currentMode === 'test' && secondsElapsed > 0) {
                const mins = Math.floor(secondsElapsed / 60);
                const secs = secondsElapsed % 60;
                html += `<p class="mb-2"><strong>Time Taken:</strong> ${mins} min ${secs} sec</p>`;
            }

            if (triageSystem === 'tst' || triageSystem === 'tst_mitt') {
                const tstAccuracy = tstTriaged > 0 ? Math.round((stats.tst.correct / tstTriaged) * 100) : 0;
                html += `
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <h5 class="font-semibold text-lg mb-3">Triage Sieve (TST)</h5>
                        <div class="grid grid-cols-3 gap-4 text-center mb-2">
                            <div class="p-3 bg-green-100 rounded">
                                <div class="text-2xl font-bold text-green-700">${stats.tst.correct}</div>
                                <div class="text-sm text-green-700">Correct</div>
                            </div>
                            <div class="p-3 bg-red-100 rounded">
                                <div class="text-2xl font-bold text-red-700">${stats.tst.underTriaged}</div>
                                <div class="text-sm text-red-700">Under-triaged</div>
                            </div>
                            <div class="p-3 bg-amber-100 rounded">
                                <div class="text-2xl font-bold text-amber-700">${stats.tst.overTriaged}</div>
                                <div class="text-sm text-amber-700">Over-triaged</div>
                            </div>
                        </div>
                        <p class="text-center font-semibold">Accuracy: ${tstAccuracy}% (${stats.tst.correct} / ${tstTriaged})</p>
                    </div>
                `;
            }

            if (triageSystem === 'mitt' || triageSystem === 'tst_mitt') {
                const mittAccuracy = mittTriaged > 0 ? Math.round((stats.mitt.correct / mittTriaged) * 100) : 0;
                html += `
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <h5 class="font-semibold text-lg mb-3">Triage Sort (MITT)</h5>
                        <div class="grid grid-cols-3 gap-4 text-center mb-2">
                            <div class="p-3 bg-green-100 rounded">
                                <div class="text-2xl font-bold text-green-700">${stats.mitt.correct}</div>
                                <div class="text-sm text-green-700">Correct</div>
                            </div>
                            <div class="p-3 bg-red-100 rounded">
                                <div class="text-2xl font-bold text-red-700">${stats.mitt.underTriaged}</div>
                                <div class="text-sm text-red-700">Under-triaged</div>
                            </div>
                            <div class="p-3 bg-amber-100 rounded">
                                <div class="text-2xl font-bold text-amber-700">${stats.mitt.overTriaged}</div>
                                <div class="text-sm text-amber-700">Over-triaged</div>
                            </div>
                        </div>
                        <p class="text-center font-semibold">Accuracy: ${mittAccuracy}% (${stats.mitt.correct} / ${mittTriaged})</p>
                    </div>
                `;
            }

            html += `</div><div><h4 class="text-xl font-bold mb-4">Detailed Results</h4>`;

            casualties.forEach(c => {
                const tstMatch = c.userTstTriage === c.correctTst;
                const mittMatch = c.userMittTriage === c.correctMitt;
                
                const tstValue = priorityValue[c.userTstTriage];
                const correctTstValue = priorityValue[c.correctTst];
                const mittValue = priorityValue[c.userMittTriage];
                const correctMittValue = priorityValue[c.correctMitt];
                
                let tstStatus = '', mittStatus = '';
                if (c.userTstTriage) {
                    if (tstMatch) tstStatus = 'âœ“ Correct';
                    else if (tstValue < correctTstValue) tstStatus = 'â†“ Under-triaged';
                    else tstStatus = 'â†‘ Over-triaged';
                }
                if (c.userMittTriage) {
                    if (mittMatch) mittStatus = 'âœ“ Correct';
                    else if (mittValue < correctMittValue) mittStatus = 'â†“ Under-triaged';
                    else mittStatus = 'â†‘ Over-triaged';
                }
                
                const hasError = (!tstMatch && c.userTstTriage) || (!mittMatch && c.userMittTriage);
                
                html += `
                    <div class="mb-4 p-3 border rounded-lg ${hasError ? 'border-red-300 bg-red-50' : 'border-gray-300'}">
                        <p class="font-semibold">Casualty #${c.id} - ${c.age}yr ${c.sex} ${c.role}</p>
                        <p class="text-sm text-gray-700 italic mb-2">"${c.injuryDescription}"</p>
                        <p class="text-xs text-gray-600 mb-2">Conscious: ${c.conscious} | RR: ${c.resps} | HR: ${c.pulse}</p>
                `;
                
                if (triageSystem === 'tst' || triageSystem === 'tst_mitt') {
                    html += `<p class="text-sm mb-1"><strong>TST:</strong> Your Triage: <span class="priority-tag ${c.userTstTriage || 'bg-gray-400'}">${(c.userTstTriage || 'None').toUpperCase()}</span> | Correct: <span class="priority-tag ${c.correctTst}">${c.correctTst.toUpperCase()}</span> <span class="${tstMatch ? 'feedback-correct' : 'feedback-incorrect'}">${tstStatus}</span></p>`;
                    
                    if (!tstMatch && c.userTstTriage) {
                        html += `<div class="text-xs bg-white p-2 rounded mt-1 mb-2"><strong>TST Explanation:</strong> ${explainTst(c)}</div>`;
                    }
                }
                
                if (triageSystem === 'mitt' || triageSystem === 'tst_mitt') {
                    html += `<p class="text-sm mb-1"><strong>MITT:</strong> Your Triage: <span class="priority-tag ${c.userMittTriage || 'bg-gray-400'}">${(c.userMittTriage || 'None').toUpperCase()}</span> | Correct: <span class="priority-tag ${c.correctMitt}">${c.correctMitt.toUpperCase()}</span> <span class="${mittMatch ? 'feedback-correct' : 'feedback-incorrect'}">${mittStatus}</span></p>`;
                    
                    if (!mittMatch && c.userMittTriage) {
                        html += `<div class="text-xs bg-white p-2 rounded mt-1"><strong>MITT Explanation:</strong> ${explainMitt(c)}</div>`;
                    }
                }

                html += `</div>`;
            });

            html += `</div>`;
            document.getElementById('reportContent').innerHTML = html;
        };

        // --- Modal Management ---
        const openTriageModal = (casualty) => {
            currentCasualty = casualty;
            triageModal.classList.remove('hidden');
            
            // Start speed round timer if applicable
            if (trainingFocus === 'speed') {
                startSpeedRoundTimer();
            }
            
            document.getElementById('modalCasualtyId').textContent = `#${casualty.id}`;
            document.getElementById('modalInjuryDescription').textContent = casualty.injuryDescription;
            
            const modalSvgContainer = document.getElementById('modal-svg-container');
            modalSvgContainer.innerHTML = generateCasualtySvg(casualty, { large: true, includeKey: true });
            
            let detailsHtml = `
                <div><strong>Age:</strong> ${casualty.age} years</div>
                <div><strong>Sex:</strong> ${casualty.sex}</div>
                <div><strong>Role:</strong> ${casualty.role}</div>
                <div><strong>Can Walk:</strong> ${casualty.canWalk ? 'Yes' : 'No'}</div>
                <div><strong>Conscious:</strong> ${casualty.conscious}</div>
                <div><strong>Breathing:</strong> ${casualty.isBreathing ? 'Yes' : 'No'}</div>
                <div><strong>Resp Rate:</strong> ${casualty.resps}/min</div>
                <div><strong>Pulse:</strong> ${casualty.pulse}/min</div>
            `;
            
            if (casualty.preExistingCondition) {
                detailsHtml += `<div class="col-span-2"><strong>Condition:</strong> ${casualty.preExistingCondition}</div>`;
            }
            
            // Add clinical findings if enabled
            if (showClinicalImages) {
                const findings = getClinicalFindings(casualty);
                if (findings.length > 0) {
                    detailsHtml += `<div class="col-span-2 mt-2 pt-2 border-t border-gray-300">
                        <strong>Clinical Findings:</strong>
                        <ul class="text-xs mt-1 ml-4 list-disc">
                            ${findings.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    </div>`;
                }
            }
            
            document.getElementById('modalPatientDetails').innerHTML = detailsHtml;
            
            const isMitt = (triageSystem === 'tst_mitt' && currentPhase === 'mitt') || triageSystem === 'mitt';
            const sectionTitle = isMitt ? 'MITT Triage Sort' : 'TST Triage Sieve';
            document.getElementById('tstSectionTitle').textContent = sectionTitle;
            
            // Reset modal state
            document.querySelectorAll('#tstSection > div').forEach(el => el.classList.add('hidden'));
            
            if (currentMode === 'teach') {
                // In teach mode, start with the first question
                if (isMitt) {
                    document.getElementById('mitt-catastrophic-bleeding').classList.remove('hidden');
                } else {
                    document.getElementById('tst-walking').classList.remove('hidden');
                }
            } else {
                // In test mode, show all priority options
                document.getElementById('priorityResult').classList.remove('hidden');
                const priorities = isMitt ? ['p1', 'p2', 'p3', 'deceased'] : ['p1', 'p2', 'p3', 'deceased'];
                const html = `
                    <div class="grid grid-cols-2 gap-4">
                        ${priorities.map(p => `
                            <button data-triage-choice="${p}" class="priority-tag ${p} text-center py-4 text-lg hover:opacity-80 transition-opacity">${p.toUpperCase()}</button>
                        `).join('')}
                    </div>
                `;
                document.getElementById('resultCard').innerHTML = html;
                document.getElementById('teachExplanation').classList.add('hidden');
            }
        };

        const closeModal = () => {
            triageModal.classList.add('hidden');
            currentCasualty = null;
            
            // Stop speed round timer
            if (trainingFocus === 'speed') {
                stopSpeedRoundTimer();
            }
        };

        const showResult = (priority, message) => {
            document.querySelectorAll('#tstSection > div').forEach(el => el.classList.add('hidden'));
            
            const isMitt = (triageSystem === 'tst_mitt' && currentPhase === 'mitt') || triageSystem === 'mitt';
            
            if (isMitt) {
                currentCasualty.userMittTriage = priority;
            } else {
                currentCasualty.userTstTriage = priority;
            }
            
            // In test mode, just record the choice and close modal without feedback
            if (currentMode === 'test') {
                currentCasualty.triageStatus = priority;
                renderCasualties();
                closeModal();
                
                // Handle speed round progression
                if (trainingFocus === 'speed') {
                    moveToNextCasualty();
                } else if (triageSystem === 'tst_mitt' && currentPhase === 'tst') {
                    const allSieved = casualties.every(c => c.userTstTriage !== null);
                    if (allSieved) startMittButton.classList.remove('hidden');
                }
                return;
            }
            
            // Teach mode - show feedback
            document.getElementById('priorityResult').classList.remove('hidden');
            
            const isCorrect = isMitt ? 
                (priority === currentCasualty.correctMitt) : 
                (priority === currentCasualty.correctTst);
            
            const correctPriority = isMitt ? currentCasualty.correctMitt : currentCasualty.correctTst;
            
            let resultHtml = `<div class="text-center py-4"><p class="text-3xl mb-2"><span class="priority-tag ${priority}">${priority.toUpperCase()}</span></p>`;
            resultHtml += `<p class="font-semibold ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">${isCorrect ? 'âœ“ Correct!' : `âœ— Incorrect. Correct triage: ${correctPriority.toUpperCase()}`}</p></div>`;
            document.getElementById('teachExplanation').classList.remove('hidden');
            const explanation = isMitt ? explainMitt(currentCasualty) : explainTst(currentCasualty);
            document.getElementById('explanationContent').innerHTML = explanation;
            
            document.getElementById('resultCard').innerHTML = resultHtml;
        };

        const explainTst = (c) => {
            let exp = '<div class="text-sm space-y-1">';
            exp += '<div><span class="font-bold">1. Can walk?</span> ';
            if (c.canWalk) { exp += 'YES &rarr; <strong class="text-green-700">P3</strong></div>'; return exp + '</div>'; }
            exp += 'NO &rarr; Continue.</div>';
            exp += '<div><span class="font-bold">2. Severe bleeding?</span> ';
            if (c.hasSevereBleeding) { exp += 'YES &rarr; <strong class="text-red-700">P1</strong></div>'; return exp + '</div>'; }
            exp += 'NO &rarr; Continue.</div>';
            exp += '<div><span class="font-bold">3. Talking?</span> ';
            if (c.isTalking) {
                exp += 'YES &rarr; Continue.</div>';
                exp += '<div><span class="font-bold">4. Penetrating torso injury?</span> ';
                if (c.hasPenetratingInjury) { exp += 'YES &rarr; <strong class="text-red-700">P1</strong></div>'; }
                else { exp += 'NO &rarr; <strong class="text-amber-700">P2</strong></div>'; }
                return exp + '</div>';
            }
            exp += 'NO &rarr; Continue.</div>';
            exp += '<div><span class="font-bold">5. Breathing?</span> ';
            if (c.isBreathing) { exp += 'YES &rarr; <strong class="text-red-700">P1</strong></div>'; return exp + '</div>'; }
            exp += 'NO &rarr; Open airway.</div>';
            if (c.airwayClears) { exp += '<div>Breathing after airway opened &rarr; <strong class="text-red-700">P1</strong></div>'; }
            else { exp += '<div>Not breathing after airway opened &rarr; <strong class="deceased">Deceased</strong></div>'; }
            return exp + '</div>';
        };

        const explainMitt = (c) => {
            let exp = '<div class="text-sm space-y-1">';
            exp += '<div><span class="font-bold">1. Catastrophic bleeding?</span> ';
            if (c.hasCatastrophicBleeding) { exp += 'YES &rarr; <strong class="text-red-700">P1</strong></div>'; return exp + '</div>'; }
            exp += 'NO &rarr; Continue.</div>';
            exp += '<div><span class="font-bold">2. Can walk?</span> ';
            if (c.canWalk) { exp += 'YES &rarr; <strong class="text-green-700">P3</strong></div>'; return exp + '</div>'; }
            exp += 'NO &rarr; Continue.</div>';
            exp += '<div><span class="font-bold">3. Breathing?</span> ';
            if (!c.isBreathing) {
                exp += 'NO &rarr; Open airway.</div>';
                if (c.airwayClears) { exp += '<div>Breathing after airway opened &rarr; <strong class="text-red-700">P1</strong></div>'; }
                else { exp += '<div>Not breathing after airway opened &rarr; <strong class="deceased">Deceased</strong></div>'; }
                return exp + '</div>';
            }
            exp += 'YES &rarr; Continue.</div>';
            exp += '<div><span class="font-bold">4. Responds to Voice?</span> ';
            if (c.conscious !== 'Alert' && c.conscious !== 'Voice') { exp += 'NO &rarr; <strong class="text-red-700">P1</strong></div>'; return exp + '</div>'; }
            exp += 'YES &rarr; Continue.</div>';
            if (c.age <= 2) { exp += '<div><span class="font-bold">5. Age > 2?</span> NO &rarr; <strong class="text-red-700">P1</strong></div>'; return exp + '</div>'; }
            exp += '<div><span class="font-bold">5. Age > 2?</span> YES &rarr; Continue.</div>';
            if (c.resps < 12 || c.resps > 23) { exp += `<div><span class="font-bold">6. RR 12-23?</span> NO (${c.resps}) &rarr; <strong class="text-red-700">P1</strong></div>`; return exp + '</div>'; }
            exp += `<div><span class="font-bold">6. RR 12-23?</span> YES (${c.resps}) &rarr; Continue.</div>`;
            if (c.pulse < 60 || c.pulse > 119) { exp += `<div><span class="font-bold">7. HR 60-119?</span> NO (${c.pulse}) &rarr; <strong class="text-amber-700">P2</strong></div>`; return exp + '</div>'; }
            exp += `<div><span class="font-bold">7. HR 60-119?</span> YES (${c.pulse}) &rarr; <strong class="text-amber-700">P2</strong></div>`;
            return exp + '</div>';
        };

        const deteriorateCasualty = () => {
            const candidates = casualties.filter(c => c.userTstTriage === 'p2' || c.userTstTriage === 'p3');
            if (candidates.length === 0) return;

            const victim = pickRandom(candidates);
            victim.conscious = 'Pain';
            victim.isTalking = false;
            victim.injuryDescription += " They have become less responsive.";
            victim.correctMitt = calculateCorrectMitt(victim);
            
            renderCasualties(victim.id);
        };

        // Speed Round Timer Management
        const startSpeedRoundTimer = () => {
            casualtyTimeRemaining = 30;
            updateSpeedTimerDisplay();
            
            if (speedRoundInterval) clearInterval(speedRoundInterval);
            
            speedRoundInterval = setInterval(() => {
                casualtyTimeRemaining--;
                updateSpeedTimerDisplay();
                
                if (casualtyTimeRemaining <= 0) {
                    autoSkipCasualty();
                }
            }, 1000);
        };

        const stopSpeedRoundTimer = () => {
            if (speedRoundInterval) {
                clearInterval(speedRoundInterval);
                speedRoundInterval = null;
            }
        };

        const updateSpeedTimerDisplay = () => {
            casualtyTimer.textContent = casualtyTimeRemaining;
            const percentage = (casualtyTimeRemaining / 30) * 100;
            speedTimerBar.style.width = percentage + '%';
        };

        const autoSkipCasualty = () => {
            stopSpeedRoundTimer();
            
            // Auto-triage as P3 if time runs out (penalty)
            if (currentCasualty) {
                const isMitt = (triageSystem === 'tst_mitt' && currentPhase === 'mitt') || triageSystem === 'mitt';
                if (isMitt) {
                    currentCasualty.userMittTriage = 'p3';
                } else {
                    currentCasualty.userTstTriage = 'p3';
                }
                currentCasualty.triageStatus = 'p3';
            }
            
            closeModal();
            renderCasualties();
            moveToNextCasualty();
        };

        const moveToNextCasualty = () => {
            currentCasualtyIndex++;
            
            if (currentCasualtyIndex < casualties.length) {
                setTimeout(() => openTriageModal(casualties[currentCasualtyIndex]), 300);
            } else {
                // All casualties triaged
                speedRoundTimer.classList.add('hidden');
                if (triageSystem === 'tst_mitt' && currentPhase === 'tst') {
                    startMittButton.classList.remove('hidden');
                }
            }
        };

        // Clinical Findings Helper
        const getClinicalFindings = (casualty) => {
            const findings = [];
            
            // Conscious level details
            if (casualty.conscious === 'Unresponsive') {
                findings.push('No response to pain or voice');
            } else if (casualty.conscious === 'Pain') {
                findings.push('Only responds to painful stimulus');
            } else if (casualty.conscious === 'Voice') {
                findings.push('Responds to voice but not fully alert');
            }
            
            // Breathing findings
            if (!casualty.isBreathing) {
                findings.push('No respiratory effort visible');
                if (casualty.airwayClears) {
                    findings.push('Airway obstruction cleared - now breathing');
                } else {
                    findings.push('Airway remains obstructed despite manoeuvres');
                }
            } else if (casualty.resps > 30) {
                findings.push('Rapid, shallow breathing pattern');
            } else if (casualty.resps < 10) {
                findings.push('Slow, irregular breathing');
            }
            
            // Circulation findings
            if (casualty.pulse > 120) {
                findings.push('Tachycardic with thready pulse');
            } else if (casualty.pulse < 50) {
                findings.push('Bradycardic');
            }
            
            // Injury-specific findings
            if (casualty.hasSevereBleeding || casualty.hasCatastrophicBleeding) {
                findings.push('Active haemorrhage visible');
                if (casualty.hasCatastrophicBleeding) {
                    findings.push('Pulsatile arterial bleeding');
                }
            }
            
            if (casualty.injuries.some(i => i.type === 'burns')) {
                findings.push('Singed nasal hairs and soot around mouth/nose');
                findings.push('Erythema and blistering visible on exposed skin');
            }
            
            if (casualty.injuries.some(i => i.type === 'head')) {
                findings.push('Haematoma visible, possible skull deformity');
            }
            
            if (casualty.injuries.some(i => i.type === 'penetrating')) {
                findings.push('Penetrating wound with possible underlying organ damage');
            }
            
            return findings;
        };

        // PDF Generation
        const generatePDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const priorityValue = {
                'deceased': 0,
                'p3': 1,
                'p2': 2,
                'p1': 3
            };
            
            const stats = { tst: { correct: 0, underTriaged: 0, overTriaged: 0 }, mitt: { correct: 0, underTriaged: 0, overTriaged: 0 } };
            
            casualties.forEach(c => {
                if (triageSystem === 'tst' || triageSystem === 'tst_mitt') {
                    if (c.userTstTriage) {
                        const userValue = priorityValue[c.userTstTriage];
                        const correctValue = priorityValue[c.correctTst];
                        if (userValue === correctValue) stats.tst.correct++;
                        else if (userValue < correctValue) stats.tst.underTriaged++;
                        else stats.tst.overTriaged++;
                    }
                }
                if (triageSystem === 'mitt' || triageSystem === 'tst_mitt') {
                    if (c.userMittTriage) {
                        const userValue = priorityValue[c.userMittTriage];
                        const correctValue = priorityValue[c.correctMitt];
                        if (userValue === correctValue) stats.mitt.correct++;
                        else if (userValue < correctValue) stats.mitt.underTriaged++;
                        else stats.mitt.overTriaged++;
                    }
                }
            });
            
            const tstTriaged = stats.tst.correct + stats.tst.underTriaged + stats.tst.overTriaged;
            const mittTriaged = stats.mitt.correct + stats.mitt.underTriaged + stats.mitt.overTriaged;
            const tstAccuracy = tstTriaged > 0 ? Math.round((stats.tst.correct / tstTriaged) * 100) : 0;
            const mittAccuracy = mittTriaged > 0 ? Math.round((stats.mitt.correct / mittTriaged) * 100) : 0;
            
            // Header with WMEBEM branding
            doc.setFillColor(37, 99, 235); // Blue
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('TST & MITT Triage Training', 105, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.setFont(undefined, 'normal');
            doc.text('WMEBEM - West Midlands Evidence Based Emergency Medicine', 105, 30, { align: 'center' });
            
            // Certificate section
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Training Certificate', 105, 55, { align: 'center' });
            
            // Date and scenario
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            const currentDate = new Date().toLocaleDateString('en-GB', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            doc.text(`Date: ${currentDate}`, 20, 70);
            doc.text(`Scenario: ${simTitle.textContent}`, 20, 78);
            doc.text(`Training System: ${triageSystem === 'tst_mitt' ? 'TST & MITT' : triageSystem.toUpperCase()}`, 20, 86);
            
            if (trainingFocus !== 'standard') {
                const focusText = {
                    'paediatric': 'Paediatric Focus',
                    'burns': 'Burns Focus',
                    'cbrn': 'CBRN Focus',
                    'speed': 'Speed Round'
                };
                doc.text(`Training Focus: ${focusText[trainingFocus]}`, 20, 94);
            }
            
            if (secondsElapsed > 0) {
                const mins = Math.floor(secondsElapsed / 60);
                const secs = secondsElapsed % 60;
                doc.text(`Time Taken: ${mins} min ${secs} sec`, 20, trainingFocus !== 'standard' ? 102 : 94);
            }
            
            // Performance Summary
            let yPos = trainingFocus !== 'standard' ? 115 : 110;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Performance Summary', 20, yPos);
            
            yPos += 10;
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            
            if (triageSystem === 'tst' || triageSystem === 'tst_mitt') {
                doc.setFont(undefined, 'bold');
                doc.text('Triage Sieve (TST):', 20, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 8;
                doc.setTextColor(22, 163, 74); // Green
                doc.text(`Correct: ${stats.tst.correct}`, 25, yPos);
                doc.setTextColor(220, 38, 38); // Red
                doc.text(`Under-triaged: ${stats.tst.underTriaged}`, 80, yPos);
                doc.setTextColor(245, 158, 11); // Amber
                doc.text(`Over-triaged: ${stats.tst.overTriaged}`, 135, yPos);
                doc.setTextColor(0, 0, 0);
                yPos += 8;
                doc.text(`Accuracy: ${tstAccuracy}% (${stats.tst.correct}/${tstTriaged})`, 25, yPos);
                yPos += 10;
            }
            
            if (triageSystem === 'mitt' || triageSystem === 'tst_mitt') {
                doc.setFont(undefined, 'bold');
                doc.text('Triage Sort (MITT):', 20, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 8;
                doc.setTextColor(22, 163, 74);
                doc.text(`Correct: ${stats.mitt.correct}`, 25, yPos);
                doc.setTextColor(220, 38, 38);
                doc.text(`Under-triaged: ${stats.mitt.underTriaged}`, 80, yPos);
                doc.setTextColor(245, 158, 11);
                doc.text(`Over-triaged: ${stats.mitt.overTriaged}`, 135, yPos);
                doc.setTextColor(0, 0, 0);
                yPos += 8;
                doc.text(`Accuracy: ${mittAccuracy}% (${stats.mitt.correct}/${mittTriaged})`, 25, yPos);
                yPos += 10;
            }
            
            // Overall assessment
            yPos += 5;
            doc.setFont(undefined, 'bold');
            doc.text('Overall Assessment:', 20, yPos);
            doc.setFont(undefined, 'normal');
            yPos += 8;
            
            const overallAccuracy = triageSystem === 'tst_mitt' ? 
                Math.round(((stats.tst.correct + stats.mitt.correct) / (tstTriaged + mittTriaged)) * 100) :
                (triageSystem === 'tst' ? tstAccuracy : mittAccuracy);
            
            let assessment = '';
            if (overallAccuracy >= 90) assessment = 'Excellent - demonstrates strong triage decision-making';
            else if (overallAccuracy >= 75) assessment = 'Good - shows competent triage skills with room for refinement';
            else if (overallAccuracy >= 60) assessment = 'Satisfactory - further practice recommended';
            else assessment = 'Requires significant additional training';
            
            doc.text(assessment, 20, yPos);
            
            // Footer
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.text('This certificate verifies completion of simulation-based triage training.', 105, 280, { align: 'center' });
            doc.text('For portfolio evidence and ARCP documentation.', 105, 285, { align: 'center' });
            
            // Save PDF
            const filename = `TST-MITT-Training-${currentDate.replace(/\s/g, '-')}.pdf`;
            doc.save(filename);
        };

        // --- Event Listeners ---
        startSimButton.addEventListener('click', startSimulation);
        endSimButton.addEventListener('click', endSimulation);
        viewAlgosButton.addEventListener('click', () => imageModal.classList.remove('hidden'));
        closeImageModalButton.addEventListener('click', () => imageModal.classList.add('hidden'));
        downloadPdfButton.addEventListener('click', generatePDF);
        
        // Clinical images toggle
        showClinicalImagesCheckbox.addEventListener('change', (e) => {
            showClinicalImages = e.target.checked;
        });
        
        // Speed round skip button
        skipCasualtyButton.addEventListener('click', autoSkipCasualty);

        // Touch/Swipe gesture support for mobile
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchEndY = 0;
        
        casualtiesContainer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });
        
        casualtiesContainer.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        }, { passive: true });
        
        const handleSwipe = () => {
            const horizontalDiff = touchEndX - touchStartX;
            const verticalDiff = Math.abs(touchEndY - touchStartY);
            
            // Only register as swipe if horizontal movement is > 50px and mostly horizontal
            if (Math.abs(horizontalDiff) > 50 && verticalDiff < 50) {
                if (horizontalDiff > 0) {
                    // Swipe right - could be used for navigation if needed
                } else {
                    // Swipe left - could be used for navigation if needed
                }
            }
        };

        casualtiesContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('triage-button')) {
                openTriageModal(casualties.find(c => c.id === parseInt(e.target.dataset.id)));
            }
        });
        
        startMittButton.addEventListener('click', () => {
            currentPhase = 'mitt';
            phaseText.textContent = "Phase 2: Perform Triage Sort (MITT) on all casualties.";
            startMittButton.classList.add('hidden');
            
            deteriorateCasualty();

            casualties.forEach(c => c.triageStatus = c.userTstTriage); // Show initial sieve result
            renderCasualties();
            
            // Reset speed round for MITT phase if in speed mode
            if (trainingFocus === 'speed') {
                currentCasualtyIndex = 0;
                speedRoundTimer.classList.remove('hidden');
                setTimeout(() => openTriageModal(casualties[0]), 500);
            }
        });

        // Setup Screen Selectors
        [modeSelector, environmentSelector, systemSelector].forEach(selector => {
            selector.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const type = selector.id.replace('Selector', '');
                    const value = e.target.dataset[type];

                    if (type === 'mode') currentMode = value;
                    if (type === 'environment') {
                        currentEnvironment = value;
                        updateIncidentTypes(value);
                    }
                    if (type === 'system') triageSystem = value;
                    
                    selector.querySelectorAll('button').forEach(btn => {
                        const btnValue = btn.dataset[type];
                        btn.classList.toggle('bg-blue-600', btnValue === value);
                        btn.classList.toggle('text-white', btnValue === value);
                        btn.classList.toggle('bg-gray-200', btnValue !== value);
                        btn.classList.toggle('text-gray-600', btnValue !== value);
                    });
                }
            });
        });
        
        triageModal.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            
            if (target.id === 'closeModalButton') { closeModal(); return; }
            if (target.id === 'confirmTriageButton') {
                 if (!currentCasualty) return;
                 const priority = currentPhase === 'tst' ? currentCasualty.userTstTriage : currentCasualty.userMittTriage;
                 if (!priority) return;
                 
                 currentCasualty.triageStatus = priority;
                 renderCasualties();
                 closeModal();

                 if (triageSystem === 'tst_mitt' && currentPhase === 'tst') {
                    const allSieved = casualties.every(c => c.userTstTriage !== null);
                    if (allSieved) startMittButton.classList.remove('hidden');
                 }
                 return;
            }
            
            const triageChoice = target.dataset.triageChoice;
            if (triageChoice) { showResult(triageChoice, `You selected ${triageChoice.toUpperCase()}.`); return; }

            const answer = target.dataset.answer;
            if (answer) {
                const isMittTeach = (triageSystem === 'tst_mitt' && currentPhase === 'mitt') || triageSystem === 'mitt';
                const allQuestions = ['tst-walking', 'tst-bleeding', 'tst-talking', 'tst-penetrating', 'mitt-catastrophic-bleeding', 'tst-breathing', 'mitt-responds-voice', 'mitt-age', 'mitt-resp-rate', 'mitt-hr'];
                const hideAll = () => allQuestions.forEach(q => document.getElementById(q).classList.add('hidden'));

                hideAll();
                switch (answer) {
                    // Shared
                    case 'walk-yes': showResult('p3', 'Casualty is able to walk.'); break;
                    case 'walk-no':
                        if (isMittTeach) { document.getElementById('tst-breathing').classList.remove('hidden'); }
                        else { document.getElementById('tst-bleeding').classList.remove('hidden'); }
                        break;
                    
                    // TST Flow
                    case 'bleeding-yes': showResult('p1', 'Severe life-threatening bleeding.'); break;
                    case 'bleeding-no': document.getElementById('tst-talking').classList.remove('hidden'); break;
                    case 'talking-yes': document.getElementById('tst-penetrating').classList.remove('hidden'); break;
                    case 'talking-no': document.getElementById('tst-breathing').classList.remove('hidden'); break;
                    case 'penetrating-yes': showResult('p1', 'Talking with penetrating torso injury.'); break;
                    case 'penetrating-no': showResult('p2', 'Talking with no penetrating torso injury.'); break;
                    
                    // MITT Flow
                    case 'cat-bleed-yes': showResult('p1', 'Catastrophic bleeding.'); break;
                    case 'cat-bleed-no': document.getElementById('tst-walking').classList.remove('hidden'); break;
                    
                    // Shared Breathing Logic
                    case 'breathe-yes': 
                        if (isMittTeach) { document.getElementById('mitt-responds-voice').classList.remove('hidden'); }
                        else { showResult('p1', 'Not talking, but breathing.'); }
                        break;
                    case 'breathe-no': 
                        if (currentCasualty.airwayClears) { showResult('p1', 'Breathing after airway opened.'); } 
                        else { showResult('deceased', 'Not breathing after airway opened.'); }
                        break;

                    // Remaining MITT
                    case 'voice-yes': document.getElementById('mitt-age').classList.remove('hidden'); break;
                    case 'voice-no': showResult('p1', 'Does not respond to voice.'); break;
                    case 'age-yes': document.getElementById('mitt-resp-rate').classList.remove('hidden'); break;
                    case 'age-no': showResult('p1', 'Aged 2 years or under.'); break;
                    case 'rr-yes': document.getElementById('mitt-hr').classList.remove('hidden'); break;
                    case 'rr-no': showResult('p1', 'Breathing rate outside 12-23.'); break;
                    case 'hr-yes': showResult('p2', 'Passed all P1 checks.'); break;
                    case 'hr-no': showResult('p2', 'Heart rate outside 60-119.'); break;
                }
                return;
            }
        });
        
        const resetToMenu = () => {
            setupScreen.classList.remove('hidden');
            simulationScreen.classList.add('hidden');
            reportModal.classList.add('hidden');
            speedRoundTimer.classList.add('hidden');
            casualties = [];
            currentPhase = 'tst';
            secondsElapsed = 0;
            casualtyTimeRemaining = 30;
            currentCasualtyIndex = 0;
            if (timerInterval) clearInterval(timerInterval);
            if (speedRoundInterval) clearInterval(speedRoundInterval);
        };
        
        closeReportButton.addEventListener('click', () => { reportModal.classList.add('hidden'); resetToMenu(); });
    });
    </script>
</body>
</html>
